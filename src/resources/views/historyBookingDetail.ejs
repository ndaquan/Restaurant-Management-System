<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>History booking</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/css/historyBooking.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <div class="main-content">
    <div class="profile-card">
      <div class="profile-info">
        <h2 style="text-align: center; font-weight: bold; margin-bottom: 10px">
          Chi ti·∫øt ƒë·∫∑t b√†n
        </h2>
      </div>
      <div class="profile-header" style="
            display: flex;
            flex-direction: column;
            align-items: start;
            padding-left: 30px;
            padding-right: 30px;
          ">
        <label class="title-history">H·ªç t√™n kh√°ch h√†ng:</label>
        <p class="content-history">
          <%= bookingDetail.customer.firstName %>
            <%= bookingDetail.customer.lastName %>
        </p>
        <label class="title-history">S·ªë ƒëi·ªán tho·∫°i:</label>
        <p class="content-history">
          <%= bookingDetail.customer.phoneNumber %>
        </p>
        <label class="title-history">M√£ b√†n:</label>
        <p class="content-history">
          <%= bookingDetail.table.idTable %>
        </p>
        <label class="title-history">S·ªë l∆∞·ª£ng ch·ªó ng·ªìi:</label>
        <p class="content-history">
          <%= bookingDetail.quantity %> (+2) ch·ªó
        </p>
        <label class="title-history">Gi·ªù ƒë·∫∑t b√†n:</label>
        <p class="content-history">
          <%= bookingDetail.orderTime %>
        </p>

        <div style="
              display: flex;
              justify-content: space-between;
              width: 100%;
              align-items: flex-end;
            ">
          <div>
            <label class="title-history">Ng√†y ƒë·∫∑t b√†n:</label>
            <p class="content-history">
              <%= bookingDetail.orderDate %>
            </p>
            <label class="title-history">Y√™u c·∫ßu th√™m:</label>
            <p class="title-history">
              <%= bookingDetail.request %>
            </p>
          </div>
          <div>
            <label class="title-history">Gi√° c·ªçc b√†n:</label>
            <p class="content-history">
              <%= bookingDetail.table.depositPrice %> VNƒê
            </p>
            <% if (bookingDetail.isPaid) { %>
              <p class="title-history" style="
                  background-color: #6aff68;
                  text-align: center;
                  padding: 3px 0px;
                  border-radius: 10px;
                ">

                ƒê√£ thanh to√°n

              </p>
              <% } else { %>
                <p class="title-history" style="
                  background-color: #ff5050;
                  text-align: center;
                  padding: 3px 10px;
                  border-radius: 10px;
                ">

                  Ch∆∞a thanh to√°n

                </p>
                <% } %>
          </div>
        </div>
        <div class="profile-header" style="
              display: flex;
              align-items: center;
              width: 100%;
              justify-content: center;
              gap: 4px;
            ">

              <a class="history__detail--btn history__detail--payment" href="/payment/<%- bookingDetail._id %>">
                Thanh to√°n
              </a>

              <form action="/bookingTable/bookingDetail/<%= bookingDetail._id %>/edit" method="GET">
                <button class="history__detail--btn history__detail--edit">
                  Ch·ªânh s·ª≠a
                </button>
              </form>

              <button class="history__detail--btn history__detail--cancel"
                onclick="cancelBooking('<%= bookingDetail._id %>', '<%= bookingDetail.customer._id %>')">
                Hu·ª∑ b√†n
              </button>
        </div>
      </div>
    </div>
  </div>
</body>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const bookingId = "<%= bookingDetail._id %>";
    const amount = "<%= bookingDetail.table.depositPrice %>"; // ho·∫∑c gi√° tr·ªã c·ª• th·ªÉ
    const isPaidFromDB = JSON.parse("<%= bookingDetail.isPaid %>");

    const editBtn = document.querySelector(".history__detail--edit");
    const cancelBtn = document.querySelector(".history__detail--cancel");
    const paymentBtn = document.querySelector(".history__detail--payment");

    // ·∫®n n√∫t n·∫øu ƒë√£ thanh to√°n (theo d·ªØ li·ªáu ban ƒë·∫ßu)
    if (isPaidFromDB) {
      if (editBtn) editBtn.style.display = "none";
      if (cancelBtn) cancelBtn.style.display = "none";
      if (paymentBtn) paymentBtn.style.display = "none";
    }

    // üëá G·ªçi API ƒë·ªÉ ki·ªÉm tra l·∫°i (trong tr∆∞·ªùng h·ª£p v·ª´a thanh to√°n m√† ch∆∞a c·∫≠p nh·∫≠t DB)
    fetch(`/payment/${bookingId}/checkPaid?amount=${amount}`)
      .then(response => response.json())
      .then(data => {
        if (data.success && data.isPaid && !isPaidFromDB) {
          // üî• G·ª≠i request c·∫≠p nh·∫≠t DB
          fetch(`/bookingTable/bookingDetail/${bookingId}/markPaid`, {
            method: "POST"
          });

          // üîÅ Reload l·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t UI
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        }
      })
      .catch(err => {
        console.error("L·ªói khi ki·ªÉm tra thanh to√°n t·ª´ trang l·ªãch s·ª≠:", err);
      });
  });

  function cancelBooking(bookingId, customerId) {
    console.log(bookingId);

    Swal.fire({
      title: "X√°c nh·∫≠n hu·ª∑ ƒë·∫∑t b√†n",
      text: "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën hu·ª∑ b√†n?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      cancelButtonColor: "#3085d6",
      confirmButtonText: "Hu·ª∑ b√†n",
      cancelButtonText: "Kh√¥ng",
    }).then((result) => {
      if (result.isConfirmed) {
        fetch("/bookingTable/bookingDetail/" + bookingId, { method: "DELETE" })
          .then((res) => res.json())
          .then((data) => {
            Swal.fire("ƒê√£ hu·ª∑!", data.message, "success").then(() => {
              window.location.href = `/bookingTable/bookingHistory/${customerId}`;
            });
          })
          .catch((err) => console.error(err));
      }
    });
  }
</script>

</html>